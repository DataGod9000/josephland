<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DataTools — Schema, Compare & Validate</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* DataCamp-style: sidebar (dark indigo) */
      --sidebar-bg: #232F5A;
      --sidebar-bg-hover: #2d3a6b;
      --sidebar-text: #fff;
      --sidebar-text-muted: rgba(255,255,255,0.75);
      --sidebar-active-bg: rgba(255,255,255,0.12);
      --sidebar-active-border: #27AE60;
      /* Content area (light) */
      --content-bg: #F0F2F5;
      --content-bg-card: #fff;
      --content-border: #E1E4E8;
      --content-border-light: #EBEEF2;
      --text: #2C3E50;
      --text-muted: #5C6B7A;
      --accent: #27AE60;
      --accent-hover: #219653;
      --accent-glow: rgba(39, 174, 96, 0.2);
      --purple: #6C5CE7;
      --purple-hover: #5b4cdb;
      --danger: #E74C3C;
      --success: #27AE60;
      --radius: 8px;
      --radius-sm: 6px;
      --radius-pill: 999px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.1);
      --transition: 0.2s ease;
      --header-height: 56px;
    }
    /* Dark mode */
    html.dark-mode {
      --content-bg: #1a1d24;
      --content-bg-card: #22262e;
      --content-border: #2d333b;
      --content-border-light: #363d48;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent-glow: rgba(39, 174, 96, 0.3);
    }
    html.dark-mode .site-header { background: #22262e; border-bottom-color: var(--content-border); }
    html.dark-mode .main-wrap { background: var(--content-bg); }
    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      color: var(--text);
    }

    /* App layout: top nav overlaps sidebar + main */
    .app-layout { display: flex; min-height: 100vh; }
    /* Top header: full width, fixed, overlaps sidebar */
    .site-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      z-index: 100;
      background: #fff;
      border-bottom: 1px solid var(--content-border);
      box-shadow: var(--shadow);
    }
    .header-inner {
      width: 100%;
      margin: 0;
      padding: 0 1.5rem;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
    }
    .logo-link {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      text-decoration: none;
      color: var(--text);
      font-weight: 700;
      font-size: 1.2rem;
      letter-spacing: -0.02em;
      transition: color var(--transition);
    }
    .logo-link:hover { color: var(--accent); }
    .logo-link .logo-icon { flex-shrink: 0; color: inherit; }
    .logo-link .logo-icon svg { display: block; width: 28px; height: 28px; }

    .sidebar {
      width: 240px;
      flex-shrink: 0;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 0 0 1.25rem;
      padding-top: var(--header-height);
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 90;
      display: flex;
      flex-direction: column;
    }
    .sidebar-section {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--sidebar-text-muted);
      padding: 1rem 1.25rem 0.5rem;
      margin-top: 0.5rem;
    }
    .sidebar-section:first-of-type { margin-top: 0; }
    .sidebar-nav { padding: 0 0.75rem; }
    .sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      color: var(--sidebar-text);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      margin-bottom: 0.15rem;
      transition: background var(--transition), color var(--transition);
      border-left: 3px solid transparent;
    }
    .sidebar-nav a:hover { background: var(--sidebar-bg-hover); }
    .sidebar-nav a.active {
      background: var(--sidebar-active-bg);
      border-left-color: var(--sidebar-active-border);
    }
    .sidebar-nav .nav-icon { font-size: 1.1rem; opacity: 0.9; width: 1.4rem; text-align: center; }
    .sidebar-nav .nav-external { font-size: 0.85rem; color: var(--sidebar-text-muted); }
    .sidebar-nav .nav-external:hover { color: var(--sidebar-text); }

    .main-wrap {
      flex: 1;
      margin-left: 240px;
      padding-top: var(--header-height);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: var(--content-bg);
    }
    .header-search {
      flex: 1;
      max-width: 360px;
      height: 40px;
      padding: 0 1rem 0 2.5rem;
      background: var(--content-bg);
      border: 1px solid var(--content-border);
      border-radius: var(--radius-pill);
      font-size: 0.9rem;
      color: var(--text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%235C6B7A' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 0.75rem center;
    }
    .header-search::placeholder { color: var(--text-muted); }
    .header-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .header-actions a {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 0.5rem 0.85rem;
      border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
    }
    .header-actions a:hover { color: var(--text); background: var(--content-bg); }
    .header-actions a.cta {
      background: var(--purple);
      color: #fff;
    }
    .header-actions a.cta:hover { background: var(--purple-hover); }
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      border: 1px solid var(--content-border);
      background: var(--content-bg);
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1.1rem;
      transition: color var(--transition), background var(--transition), border-color var(--transition);
    }
    .theme-toggle:hover { color: var(--text); background: var(--content-border-light); }
    .theme-toggle:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .theme-toggle .theme-icon-dark { display: none; }
    .theme-toggle .theme-icon-light { display: inline; }
    html.dark-mode .theme-toggle .theme-icon-light { display: none; }
    html.dark-mode .theme-toggle .theme-icon-dark { display: inline; }
    .header-actions a:focus-visible,
    .logo-link:focus-visible,
    .sidebar-nav a:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Main content */
    main {
      flex: 1;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      padding: 0 1.5rem 4rem;
    }

    /* Hero (Home) */
    .hero {
      padding: 3rem 0 4rem;
      text-align: center;
    }
    .hero h1 {
      font-size: clamp(1.9rem, 4.5vw, 2.75rem);
      font-weight: 700;
      letter-spacing: -0.03em;
      margin: 0 0 1rem;
      line-height: 1.25;
      color: var(--text);
    }
    .hero .accent { color: var(--accent); }
    .hero p {
      font-size: 1.1rem;
      color: var(--text-muted);
      max-width: 520px;
      margin: 0 auto 2.5rem;
      line-height: 1.6;
    }
    .feature-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.25rem;
      justify-content: center;
    }
    .feature-card {
      display: block;
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      border-radius: var(--radius);
      padding: 1.5rem;
      text-decoration: none;
      color: var(--text);
      text-align: left;
      transition: border-color var(--transition), transform var(--transition), box-shadow var(--transition);
      box-shadow: var(--shadow);
    }
    .feature-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .feature-card h3 {
      font-size: 1.05rem;
      margin: 0 0 0.35rem;
      color: var(--accent);
      font-weight: 600;
    }
    .feature-card p {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.5;
    }

    /* Views (all hidden until active) */
    .view {
      display: none;
      padding: 2rem 0 3rem;
    }
    .view.active { display: block; }
    .view.hero-section { padding: 4rem 0 5rem; }
    .section h2 {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 0 0 0.5rem;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .section .subtitle {
      color: var(--text-muted);
      font-size: 0.95rem;
      margin-bottom: 1.75rem;
      line-height: 1.6;
    }
    .section .subtitle code {
      font-family: 'DM Mono', monospace;
      font-size: 0.85em;
      background: var(--content-bg);
      padding: 0.2rem 0.45rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--content-border);
      color: var(--text);
    }
    .tool-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }
    @media (max-width: 900px) { .tool-grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      border-radius: var(--radius);
      padding: 1.75rem;
      box-shadow: var(--shadow);
      transition: box-shadow var(--transition);
    }
    .card:hover { box-shadow: var(--shadow-md); }
    .card h3 {
      font-size: 1.05rem;
      margin: 0 0 1rem;
      color: var(--text);
      font-weight: 600;
    }
    .card label {
      display: block;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    .card label:first-of-type { margin-top: 0; }
    .card input,
    .card select,
    .card textarea {
      width: 100%;
      padding: 0.65rem 0.85rem;
      background: #fff;
      border: 1px solid var(--content-border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.85rem;
      border-radius: var(--radius-sm);
      margin-top: 0.4rem;
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .card input::placeholder,
    .card textarea::placeholder { color: var(--text-muted); }
    .card input:focus,
    .card select:focus,
    .card textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .card textarea {
      min-height: 120px;
      resize: vertical;
    }
    .card button.primary {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 0.65rem 1.35rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      border-radius: var(--radius-sm);
      margin-top: 1rem;
      font-family: inherit;
      transition: background var(--transition), transform var(--transition);
      box-shadow: var(--shadow);
    }
    .card .assets-toolbar-row button.primary { margin-top: 0; margin-bottom: 0; }
    .card .assets-toolbar-row input { margin: 0; }
    .card button.primary:hover { background: var(--accent-hover); }
    .card button.primary:active { transform: scale(0.98); }
    .result-box {
      margin-top: 1rem;
      padding: 1rem 1.1rem;
      background: var(--content-bg);
      border: 1px solid var(--content-border);
      border-radius: var(--radius-sm);
      white-space: pre-wrap;
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      line-height: 1.5;
      max-height: 280px;
      overflow: auto;
      color: var(--text);
    }
    .result-box.error { border-color: var(--danger); color: var(--danger); background: rgba(231,76,60,0.06); }
    .result-box.success { border-color: var(--success); background: rgba(39,174,96,0.06); }
    .result-box:empty { display: none; }

    /* Create table flow */
    .create-table-flow { max-width: 720px; }
    .create-table-flow .step {
      margin-bottom: 1.5rem;
    }
    .create-table-flow .step label { display: block; margin-bottom: 0.35rem; }
    .create-table-flow textarea.ddl-input {
      min-height: 140px;
      resize: vertical;
    }
    .create-table-flow .row-inline {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .create-table-flow .row-inline .env-wrap { min-width: 120px; }
    .create-table-flow .row-inline label { margin-top: 0; }
    .columns-block {
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--content-bg);
      border: 1px solid var(--content-border);
      border-radius: var(--radius-sm);
      display: none;
    }
    .columns-block.visible { display: block; }
    .columns-block h4 {
      font-size: 0.95rem;
      margin: 0 0 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    .columns-block .table-name {
      font-family: 'DM Mono', monospace;
      color: var(--accent);
      font-weight: 500;
    }
    .cols-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .cols-table th {
      text-align: left;
      padding: 0.6rem 0.6rem 0.6rem 0;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border-bottom: 1px solid var(--content-border);
    }
    .cols-table td {
      padding: 0.6rem 0.6rem 0.6rem 0;
      border-bottom: 1px solid var(--content-border-light);
      vertical-align: middle;
    }
    .cols-table tr:last-child td { border-bottom: none; }
    .cols-table tr:hover td { background: var(--content-bg); }
    .cols-table .col-name { font-family: 'DM Mono', monospace; color: var(--text); font-weight: 500; }
    .cols-table select,
    .cols-table input[type="text"] {
      width: 100%;
      min-width: 0;
      padding: 0.4rem 0.5rem;
      background: #fff;
      border: 1px solid var(--content-border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.8rem;
      border-radius: var(--radius-sm);
    }
    .cols-table input[type="checkbox"] {
      width: 1rem;
      height: 1rem;
      accent-color: var(--accent);
    }
    .cols-table .type-cell { max-width: 180px; }
    .cols-table .default-cell { max-width: 140px; }
    .cols-table .comment-cell { max-width: 160px; }
    .cols-table .comment-cell input { font-family: inherit; }
    .comment-governance { font-size: 0.8rem; color: var(--text-muted); margin: 0.75rem 0 0; }
    .btn-row { margin-top: 1rem; gap: 0.75rem; }
    .btn-create-table { margin-top: 0; }
    .create-table-flow .result-box { margin-top: 1rem; }

    /* Assets */
    .assets-toolbar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .assets-toolbar-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: nowrap;
      width: 100%;
      min-height: 2.5rem;
    }
    .assets-toolbar-row .assets-env-wrap {
      flex-shrink: 0;
      position: relative;
      width: 10rem;
      height: 2.5rem;
    }
    .assets-env-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      width: 100%;
      height: 100%;
      min-height: 2.5rem;
      padding: 0 0.75rem;
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: border-color var(--transition), box-shadow var(--transition);
      font-family: inherit;
      text-align: left;
      box-sizing: border-box;
    }
    .assets-env-trigger:hover { border-color: var(--text-muted); }
    .assets-env-trigger:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .assets-env-trigger[aria-expanded="true"] { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
    .assets-env-chevron {
      flex-shrink: 0;
      font-size: 0.65rem;
      color: var(--text-muted);
      transition: transform var(--transition);
    }
    .assets-env-wrap.open .assets-env-chevron { transform: rotate(180deg); }
    .assets-env-panel {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 0.25rem;
      min-width: 100%;
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 50;
      display: none;
      padding: 0.25rem 0;
    }
    .assets-env-wrap.open .assets-env-panel { display: block; }
    .assets-env-option {
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      color: var(--text);
      cursor: pointer;
      transition: background var(--transition);
    }
    .assets-env-option:hover { background: var(--content-bg); }
    .assets-env-option.active { background: var(--accent-glow); color: var(--accent); font-weight: 500; }
    .assets-toolbar-row .assets-search {
      flex: 1 1 0%;
      min-width: 0;
      width: 0;
      height: 2.5rem;
      min-height: 2.5rem;
      margin: 0;
      padding: 0 0.85rem;
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      color: var(--text);
      font-size: 0.9rem;
      line-height: 1;
      border-radius: var(--radius-sm);
      transition: border-color var(--transition), box-shadow var(--transition);
      box-sizing: border-box;
      align-self: stretch;
      font-family: inherit;
    }
    .assets-search::placeholder { color: var(--text-muted); }
    .assets-search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .assets-toolbar-row .btn-create-table,
    .card .assets-toolbar-row button.primary.btn-create-table {
      flex-shrink: 0;
      height: 2.5rem;
      min-height: 2.5rem;
      padding: 0 1.25rem;
      margin: 0;
      line-height: 1;
      box-sizing: border-box;
    }
    .assets-filter-tabs { display: flex; gap: 0.25rem; flex-wrap: wrap; }
    .filter-tab {
      padding: 0.5rem 0.9rem;
      border: none;
      background: var(--content-bg);
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-family: inherit;
      transition: background var(--transition), color var(--transition);
    }
    .filter-tab:hover { color: var(--text); background: var(--content-border-light); }
    .filter-tab.active { background: var(--text); color: #fff; }
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 1.25rem;
    }
    .modal-overlay.visible { display: flex; }
    .modal-card {
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      border-radius: var(--radius);
      padding: 1.6rem;
      max-width: 420px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }
    .modal-card h3 { margin: 0 0 0.75rem; font-size: 1.15rem; font-weight: 600; color: var(--text); }
    .modal-card p { margin: 0 0 0.5rem; font-size: 0.95rem; color: var(--text-muted); }
    .modal-delete .modal-summary { font-weight: 500; color: var(--text); margin-bottom: 0.75rem; }
    .modal-delete .modal-steps {
      margin: 0 0 1.25rem; padding-left: 1.25rem; font-size: 0.9rem; color: var(--text-muted);
      line-height: 1.6;
    }
    .modal-delete .modal-steps code { font-size: 0.85em; background: var(--content-bg); padding: 0.15rem 0.4rem; border-radius: var(--radius-sm); border: 1px solid var(--content-border); }
    .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.25rem; justify-content: flex-end; }
    /* Toast – top right, below header */
    .toast-container {
      position: fixed;
      top: 4rem;
      right: 1.25rem;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      max-width: 340px;
      opacity: 1;
      transition: opacity 0.4s ease;
      pointer-events: auto;
      border: none;
    }
    .toast .toast-message { flex: 1; min-width: 0; }
    .toast-close {
      flex-shrink: 0;
      background: none;
      border: none;
      color: inherit;
      opacity: 0.8;
      font-size: 1.2rem;
      line-height: 1;
      padding: 0 0.2rem;
      cursor: pointer;
    }
    .toast-close:hover { opacity: 1; }
    .toast.fade { opacity: 0; }
    .toast.success { background: var(--success); color: #fff; }
    .toast.error { background: var(--danger); color: #fff; }
    .modal-btn { padding: 0.55rem 1.1rem; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 500; cursor: pointer; font-family: inherit; border: none; transition: background var(--transition), transform var(--transition); }
    .modal-btn.primary { background: var(--accent); color: #fff; }
    .modal-btn.primary:hover { background: var(--accent-hover); }
    .modal-btn.primary:active { transform: scale(0.98); }
    .modal-btn.secondary { background: var(--content-bg); color: var(--text); border: 1px solid var(--content-border); }
    .modal-btn.secondary:hover { background: var(--content-border-light); }
    /* Query modal */
    .modal-query { max-width: 640px; }
    .modal-query-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .modal-query-header h3 { margin: 0; }
    .modal-query-close {
      background: none; border: none; color: var(--text-muted); font-size: 1.5rem; line-height: 1;
      cursor: pointer; padding: 0 0.25rem;
    }
    .modal-query-close:hover { color: var(--text); }
    .modal-query-hint { font-size: 0.8rem; color: var(--text-muted); margin: 0 0 0.75rem; }
    .modal-query-hint code { font-size: 0.9em; }
    .query-sql-input {
      width: 100%; padding: 0.75rem; margin-bottom: 1rem;
      background: #fff; border: 1px solid var(--content-border); color: var(--text);
      font-family: 'DM Mono', monospace; font-size: 0.85rem; border-radius: var(--radius-sm);
      resize: vertical; min-height: 100px;
    }
    .query-results-wrap { margin-top: 1rem; border-top: 1px solid var(--content-border); padding-top: 1rem; max-height: 320px; overflow: auto; }
    .query-results-loading { color: var(--text-muted); font-size: 0.9rem; }
    .query-results-error { color: var(--danger); font-size: 0.9rem; }
    .query-results-table-wrap { overflow: auto; }
    .query-results-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; border-radius: var(--radius-sm); overflow: hidden; }
    .query-results-table th, .query-results-table td { padding: 0.5rem 0.65rem; text-align: left; border: 1px solid var(--content-border); }
    .query-results-table th { background: var(--content-bg); color: var(--text-muted); font-weight: 600; font-size: 0.78rem; text-transform: uppercase; letter-spacing: 0.03em; }
    .query-results-table tr:nth-child(even) { background: var(--content-bg); }
    .query-results-table tbody tr:hover { background: var(--content-border-light); }
    .query-results-meta { font-size: 0.8rem; color: var(--text-muted); margin: 0.5rem 0 0; }
    /* Table details modal */
    .modal-details { max-width: 560px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-details #details-modal-body { overflow: auto; }
    .details-stats { display: grid; gap: 0.5rem; margin-bottom: 1rem; }
    .details-row { display: flex; gap: 0.75rem; font-size: 0.9rem; }
    .details-label { color: var(--text-muted); min-width: 5rem; }
    .details-sample-title { font-size: 0.95rem; margin: 0 0 0.5rem; color: var(--text-muted); font-weight: 500; }
    .details-sample-wrap { overflow: auto; max-height: 240px; }
    .assets-list .text-muted { font-size: 0.9rem; margin: 0; }
    .assets-ul { list-style: none; margin: 0; padding: 0; }
    .assets-ul li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      border: 1px solid var(--content-border);
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      background: var(--content-bg-card);
      transition: border-color var(--transition), background var(--transition);
    }
    .assets-ul li:hover { background: var(--content-bg); border-color: var(--content-border); }
    .assets-ul li .table-label { font-family: 'DM Mono', monospace; color: var(--text); font-weight: 500; }
    .assets-ul li .table-meta { font-size: 0.8rem; color: var(--text-muted); margin-left: 0.5rem; }
    .assets-actions { position: relative; }
    .assets-actions .menu-trigger {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.35rem 0.6rem;
      font-size: 1.1rem;
      line-height: 1;
      border-radius: var(--radius-sm);
      transition: color var(--transition), background var(--transition);
    }
    .assets-actions .menu-trigger:hover { color: var(--text); background: var(--content-bg); }
    .assets-actions .menu-dropdown {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 0.35rem;
      min-width: 160px;
      background: var(--content-bg-card);
      border: 1px solid var(--content-border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 50;
      padding: 0.35rem 0;
    }
    .assets-actions .menu-dropdown.visible { display: block; }
    .assets-actions .menu-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.55rem 0.9rem;
      border: none;
      background: none;
      color: var(--text);
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
      transition: background var(--transition);
    }
    .assets-actions .menu-dropdown button:hover { background: var(--content-bg); }
    .assets-actions .menu-dropdown button.delete { color: var(--danger); }
    .assets-actions .menu-dropdown button.delete:hover { background: rgba(231,76,60,0.08); }
    .assets-actions .menu-dropdown button.restore { color: var(--success); }
    .assets-actions .menu-dropdown button.generate-select,
    .assets-actions .menu-dropdown button.generate-ddl { color: var(--accent); }

    /* Footer */
    .site-footer {
      border-top: 1px solid var(--content-border);
      padding: 1.5rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
      background: var(--content-bg-card);
    }
    .site-footer a {
      color: var(--accent);
      text-decoration: none;
      transition: color var(--transition);
    }
    .site-footer a:hover { color: var(--accent-hover); }
    @media (max-width: 768px) {
      .sidebar { width: 64px; padding-top: var(--header-height); padding-bottom: 0.5rem; }
      .sidebar-section, .sidebar-nav a span:not(.nav-icon) { display: none; }
      .sidebar-nav a { justify-content: center; padding: 0.75rem; }
      .main-wrap { margin-left: 64px; }
    }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    /* Accessibility: skip link */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 0.5rem;
      z-index: 201;
      padding: 0.6rem 1rem;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border-radius: var(--radius-sm);
      text-decoration: none;
      transition: top 0.2s ease;
    }
    .skip-link:focus { top: 0.5rem; outline: 2px solid var(--text); outline-offset: 2px; }
    /* Focus visible for interactive elements */
    .card button.primary:focus-visible,
    .filter-tab:focus-visible,
    .modal-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .card input:focus-visible, .card select:focus-visible, .card textarea:focus-visible { outline: none; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-section">Tools</div>
      <nav class="sidebar-nav">
        <a href="#home" class="nav-link active" data-route="home"><span class="nav-icon">⌂</span><span>Home</span></a>
        <a href="#assets" class="nav-link" data-route="assets"><span class="nav-icon">▦</span><span>Assets</span></a>
        <a href="#ddl" class="nav-link" data-route="ddl"><span class="nav-icon">⟨⟩</span><span>DDL</span></a>
        <a href="#compare" class="nav-link" data-route="compare"><span class="nav-icon">⇄</span><span>Compare</span></a>
        <a href="#validate" class="nav-link" data-route="validate"><span class="nav-icon">✓</span><span>Validate</span></a>
      </nav>
      <div class="sidebar-section">External</div>
      <nav class="sidebar-nav">
        <a href="https://supabase.com/dashboard/project/dzmyvxmadpbfobrxkneo/sql/afbdac77-ccf5-4f25-8f69-a87b6739d8ca" class="nav-external" target="_blank" rel="noopener noreferrer">Supabase</a>
        <a href="/docs" class="nav-external" target="_blank" rel="noopener">API docs</a>
      </nav>
    </aside>
    <header class="site-header">
      <div class="header-inner">
        <a href="#home" class="logo-link" data-route="home" aria-label="DataTools home">
          <span class="logo-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="none" aria-hidden="true"><rect x="2" y="2" width="28" height="28" rx="6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 11h28M2 18h28M2 25h28" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="24" cy="7" r="3.5" fill="currentColor" opacity=".9"/></svg></span>
          <span>DataTools</span>
        </a>
        <input type="text" class="header-search" placeholder="Search" aria-label="Search" />
        <div class="header-actions">
          <button type="button" class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark/light mode">
            <span class="theme-icon-light" aria-hidden="true">☀</span>
            <span class="theme-icon-dark" aria-hidden="true">☽</span>
          </button>
          <a href="/docs" target="_blank" rel="noopener" class="cta">API docs</a>
        </div>
      </div>
    </header>
    <div class="main-wrap">

  <main id="main-content" tabindex="-1">
    <!-- Home -->
    <section id="view-home" class="view hero-section">
      <div class="hero">
        <h1>Schema, compare & validate <span class="accent">in one place</span></h1>
        <p>Parse and apply DDL, suggest join keys, run table comparisons, and validate data quality—all from your browser.</p>
        <div class="feature-cards">
          <a href="#assets" class="feature-card" data-route="assets">
            <h3>Assets</h3>
            <p>View all tables created via this app. Create new tables or schedule a table for deletion (renamed, dropped in 7 days).</p>
          </a>
          <a href="#ddl" class="feature-card" data-route="ddl">
            <h3>DDL</h3>
            <p>Parse CREATE TABLE statements and apply them to dev or prod. Schema and table registry updated automatically.</p>
          </a>
          <a href="#compare" class="feature-card" data-route="compare">
            <h3>Compare</h3>
            <p>Suggest join keys between two tables, then run a comparison to see row counts and missing keys on each side.</p>
          </a>
          <a href="#validate" class="feature-card" data-route="validate">
            <h3>Validate</h3>
            <p>Run checks on a table: row count, null counts per column, and duplicate key detection.</p>
          </a>
        </div>
      </div>
    </section>

    <!-- Assets -->
    <section id="view-assets" class="section view">
      <h2>Assets</h2>
      <p class="subtitle">Tables created via this app. Filter by environment, search by name, or view backups and to-be-deleted tables.</p>
      <div class="card">
        <div class="assets-toolbar">
          <select id="assets-env" aria-hidden="true" tabindex="-1" class="visually-hidden">
            <option value="">All environments</option>
            <option value="dev">dev</option>
            <option value="prod">prod</option>
          </select>
          <div class="assets-toolbar-row">
            <div class="assets-env-wrap" id="assets-env-wrap">
              <button type="button" class="assets-env-trigger" id="assets-env-trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Filter by environment">
                <span class="assets-env-label">All environments</span>
                <span class="assets-env-chevron" aria-hidden="true">▾</span>
              </button>
              <div class="assets-env-panel" role="listbox" id="assets-env-panel">
                <div class="assets-env-option active" role="option" data-value="">All environments</div>
                <div class="assets-env-option" role="option" data-value="dev">dev</div>
                <div class="assets-env-option" role="option" data-value="prod">prod</div>
              </div>
            </div>
            <input type="text" id="assets-search" class="assets-search" placeholder="Search tables…" aria-label="Search tables" />
            <button type="button" class="primary btn-create-table" id="btn-assets-create-table">Create table</button>
          </div>
          <div class="assets-filter-tabs" role="tablist" aria-label="Asset type">
            <button type="button" class="filter-tab active" data-filter="tables" role="tab" aria-selected="true">Tables</button>
            <button type="button" class="filter-tab" data-filter="backups" role="tab" aria-selected="false">Backups</button>
            <button type="button" class="filter-tab" data-filter="to_be_deleted" role="tab" aria-selected="false">To be deleted</button>
          </div>
        </div>
        <div id="assets-list" class="assets-list">
          <p class="text-muted" id="assets-loading">Loading…</p>
          <p class="text-muted" id="assets-empty" style="display:none;">No tables match. Click &quot;Create table&quot; to add one (Tables view).</p>
          <ul id="assets-table-ul" class="assets-ul"></ul>
        </div>
      </div>
    </section>
    <!-- Delete confirmation modal -->
    <div id="assets-delete-modal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card modal-delete">
        <h3>Schedule for deletion</h3>
        <p class="modal-summary" id="assets-delete-modal-table"></p>
        <ul class="modal-steps">
          <li>To be backed up as <code id="assets-delete-backup-name"></code></li>
          <li>To be renamed to <code id="assets-delete-renamed-name"></code></li>
          <li>Will be dropped in 7 days</li>
        </ul>
        <div class="modal-actions">
          <button type="button" class="modal-btn secondary" id="assets-delete-cancel">Cancel</button>
          <button type="button" class="modal-btn primary" id="assets-delete-confirm">Delete</button>
        </div>
      </div>
    </div>
    <!-- SQL Query modal -->
    <div id="query-modal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card modal-query">
        <div class="modal-query-header">
          <h3>Run SQL query</h3>
          <button type="button" class="modal-query-close" id="query-modal-close" aria-label="Close">&times;</button>
        </div>
        <p class="modal-query-hint">Read-only: only <code>SELECT</code> is allowed. Max 500 rows. Use for quick lookups.</p>
        <textarea id="query-sql" class="query-sql-input" placeholder="SELECT * FROM dev.ods_josephco_growth_users_di LIMIT 10" rows="4"></textarea>
        <div class="modal-actions">
          <button type="button" class="modal-btn secondary" id="query-modal-cancel">Close</button>
          <button type="button" class="modal-btn primary" id="query-run-btn">Run</button>
        </div>
        <div id="query-results-wrap" class="query-results-wrap">
          <div id="query-results-loading" class="query-results-loading" style="display:none;">Running…</div>
          <div id="query-results-error" class="query-results-error" style="display:none;"></div>
          <div id="query-results-table-wrap" class="query-results-table-wrap" style="display:none;">
            <table id="query-results-table" class="query-results-table"></table>
            <p id="query-results-meta" class="query-results-meta"></p>
          </div>
        </div>
      </div>
    </div>
    <!-- Table details modal -->
    <div id="details-modal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card modal-details">
        <div class="modal-query-header">
          <h3 id="details-modal-title">Table details</h3>
          <button type="button" class="modal-query-close" id="details-modal-close" aria-label="Close">&times;</button>
        </div>
        <div id="details-modal-body">
          <div class="details-stats">
            <div class="details-row"><span class="details-label">Environment</span><span id="details-env"></span></div>
            <div class="details-row"><span class="details-label">Owner</span><span id="details-owner"></span></div>
            <div class="details-row"><span class="details-label">Rows</span><span id="details-rows"></span></div>
            <div class="details-row"><span class="details-label">Size</span><span id="details-size"></span></div>
          </div>
          <h4 class="details-sample-title">Sample data (up to 10 rows)</h4>
          <div id="details-sample-wrap" class="details-sample-wrap">
            <table id="details-sample-table" class="query-results-table"></table>
            <p id="details-sample-empty" class="query-results-meta" style="display:none;">No rows.</p>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast container (top-right) -->
    <div id="toast-container" class="toast-container" aria-live="polite"></div>

    <!-- DDL -->
    <section id="view-ddl" class="section view">
      <h2>Create table</h2>
      <p class="subtitle">Table name: <strong>{ods|dws|dim|ads|dwd}_josephco_{trade|growth}_{tablename}_{di|df|hi|hf}</strong>. Example: <code>ods_josephco_growth_users_di</code>. Each column must have a comment in English and Chinese (editable below; or use &quot;Generate comments with AI&quot;). Paste DDL → Parse → edit → Create.</p>
      <div class="card create-table-flow">
        <div class="step">
          <label>CREATE TABLE statement</label>
          <textarea id="create-ddl" class="ddl-input" placeholder="CREATE TABLE ods_josephco_growth_users_di (&#10;  id BIGINT PRIMARY KEY,&#10;  email VARCHAR(255) NOT NULL,&#10;  name TEXT,&#10;  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP&#10;);"></textarea>
        </div>
        <div class="row-inline">
          <div class="env-wrap">
            <label>Environment</label>
            <select id="create-env">
              <option value="dev">dev</option>
              <option value="prod">prod</option>
            </select>
          </div>
          <button type="button" class="primary" id="btn-parse-ddl">Parse &amp; edit columns</button>
        </div>
        <div id="columns-block" class="columns-block">
          <h4>Table: <span id="parsed-table-name" class="table-name"></span></h4>
          <table class="cols-table">
            <thead>
              <tr>
                <th>Column</th>
                <th class="type-cell">Data type</th>
                <th class="comment-cell">Comment (EN)</th>
                <th class="comment-cell">Comment (ZH)</th>
              </tr>
            </thead>
            <tbody id="columns-tbody"></tbody>
          </table>
          <p class="comment-governance">Data governance: every column must have both English and Chinese comments.</p>
          <div class="row-inline btn-row">
            <button type="button" class="primary" id="btn-suggest-comments">Generate comments with AI</button>
            <button type="button" class="primary btn-create-table" id="btn-create-table">Create table</button>
          </div>
        </div>
        <div id="result-create" class="result-box"></div>
      </div>
    </section>

    <!-- Compare -->
    <section id="view-compare" class="section view">
      <h2>Compare</h2>
      <p class="subtitle">Suggest join keys from common columns, then run a comparison to see counts and a sample of differences.</p>
      <div class="tool-grid">
        <div class="card">
          <h3>Suggest join keys</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin:0 0 1rem;">Find columns that appear in both tables (same name and type) and score them as potential join keys.</p>
          <label>Left table</label>
          <input type="text" id="suggest-left" value="users" placeholder="users" />
          <label>Right table</label>
          <input type="text" id="suggest-right" value="orders" placeholder="orders" />
          <label>Environment schema</label>
          <select id="suggest-schema"><option value="dev">dev</option><option value="prod">prod</option></select>
          <label>Max candidates</label>
          <input type="number" id="suggest-max" value="5" min="1" max="20" />
          <button type="button" class="primary" id="btn-suggest">Suggest keys</button>
          <div id="result-suggest" class="result-box"></div>
        </div>
        <div class="card">
          <h3>Run comparison</h3>
          <p style="font-size:0.85rem;color:var(--text-muted);margin:0 0 1rem;">Compare two tables by join keys: row counts, missing-in-left/right, and a sample of differing rows.</p>
          <label>Left table</label>
          <input type="text" id="compare-left" value="users" />
          <label>Right table</label>
          <input type="text" id="compare-right" value="orders" />
          <label>Environment schema</label>
          <select id="compare-schema"><option value="dev">dev</option><option value="prod">prod</option></select>
          <label>Join keys (comma-separated)</label>
          <input type="text" id="compare-keys" value="id" placeholder="id" />
          <label>Sample limit</label>
          <input type="number" id="compare-limit" value="50" min="1" max="1000" />
          <button type="button" class="primary" id="btn-compare">Run compare</button>
          <div id="result-compare" class="result-box"></div>
        </div>
      </div>
    </section>

    <!-- Validate -->
    <section id="view-validate" class="section view">
      <h2>Validate</h2>
      <p class="subtitle">Run data quality checks on a table: total rows, null counts per column, and duplicate key groups.</p>
      <div class="card" style="max-width: 32rem;">
        <h3>Run validation</h3>
        <p style="font-size:0.85rem;color:var(--text-muted);margin:0 0 1rem;">Results are stored in the validation_runs table and written to the audit log.</p>
        <label>Target table</label>
        <input type="text" id="validate-table" value="users" placeholder="users" />
        <label>Environment schema</label>
        <select id="validate-schema"><option value="dev">dev</option><option value="prod">prod</option></select>
        <label>Key columns (comma-separated, optional)</label>
        <input type="text" id="validate-keys" value="id" placeholder="id" />
        <button type="button" class="primary" id="btn-validate">Run validate</button>
        <div id="result-validate" class="result-box"></div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    DataTools portfolio · FastAPI + Supabase Postgres ·
    <a href="/docs" target="_blank" rel="noopener">OpenAPI /docs</a>
  </footer>
    </div>
  </div>

  <script>
    const api = (path, body) =>
      fetch(path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined
      }).then(async r => {
        let json;
        try {
          const text = await r.text();
          json = text ? JSON.parse(text) : {};
        } catch (_) {
          json = { detail: r.statusText || 'Request failed' };
        }
        return { ok: r.ok, json };
      });
    const getApi = (path) =>
      fetch(path).then(async r => {
        let json;
        try {
          const text = await r.text();
          json = text ? JSON.parse(text) : {};
        } catch (_) {
          json = {};
        }
        return { ok: r.ok, json };
      });

    function showResult(el, data, isError) {
      el.className = 'result-box ' + (isError ? 'error' : 'success');
      el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
      el.style.display = 'block';
    }

    function route() {
      const hash = (window.location.hash || '#home').slice(1).toLowerCase();
      const view = hash === '' ? 'home' : hash;
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      const section = document.getElementById('view-' + view);
      if (section) section.classList.add('active');
      document.querySelectorAll('.nav-link').forEach(a => {
        a.classList.toggle('active', a.getAttribute('data-route') === view || (a.getAttribute('href') === '#home' && view === 'home'));
      });
      if (view === 'assets') loadAssets();
    }

    function getAssetsParams() {
      const env = document.getElementById('assets-env');
      const filterTab = document.querySelector('.filter-tab.active');
      const filter = (filterTab && filterTab.dataset.filter) || 'tables';
      const q = (document.getElementById('assets-search') && document.getElementById('assets-search').value) || '';
      return {
        env_schema: (env && env.value) || '',
        filter: filter,
        q: q.trim()
      };
    }
    function loadAssets() {
      const loadingEl = document.getElementById('assets-loading');
      const emptyEl = document.getElementById('assets-empty');
      const ul = document.getElementById('assets-table-ul');
      if (!ul) return;
      const params = getAssetsParams();
      const query = new URLSearchParams();
      if (params.env_schema) query.set('env_schema', params.env_schema);
      if (params.filter) query.set('filter', params.filter);
      if (params.q) query.set('q', params.q);
      const url = '/assets/tables' + (query.toString() ? '?' + query.toString() : '');
      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      emptyEl.textContent = 'No tables match. Click "Create table" to add one (Tables view).';
      ul.innerHTML = '';
      getApi(url).then(res => {
        loadingEl.style.display = 'none';
        const tables = (res.ok && res.json.tables) ? res.json.tables : [];
        if (tables.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }
        tables.forEach(t => {
          const li = document.createElement('li');
          let typeLabel = t.type === 'backup' ? ' (backup)' : '';
          if (t.type === 'to_be_deleted') {
            const daysLeft = t.delete_after ? Math.ceil((new Date(t.delete_after) - new Date()) / (24 * 60 * 60 * 1000)) : null;
            typeLabel = daysLeft !== null
              ? (daysLeft <= 0 ? ' (deleted today)' : ' (' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's') + ' left)')
              : ' (to be deleted)';
          }
          const actionsHtml = (t.type === 'table')
            ? '<div class="assets-actions">' +
              '<button type="button" class="menu-trigger" aria-label="Actions">⋯</button>' +
              '<div class="menu-dropdown"><button type="button" class="show-details">Show details</button><button type="button" class="generate-select">Generate SELECT</button><button type="button" class="generate-ddl">Generate DDL</button><button type="button" class="delete">Delete</button></div></div>'
            : (t.type === 'backup')
            ? '<div class="assets-actions">' +
              '<button type="button" class="menu-trigger" aria-label="Actions">⋯</button>' +
              '<div class="menu-dropdown"><button type="button" class="show-details">Show details</button><button type="button" class="restore">Restore table</button></div></div>'
            : (t.type === 'to_be_deleted')
            ? '<div class="assets-actions">' +
              '<button type="button" class="menu-trigger" aria-label="Actions">⋯</button>' +
              '<div class="menu-dropdown"><button type="button" class="show-details">Show details</button></div></div>'
            : '';
          li.innerHTML =
            '<span><span class="table-label">' + escapeHtml(t.env_schema + '.' + t.table_name) + '</span><span class="table-meta">' + escapeHtml(t.env_schema) + typeLabel + '</span></span>' +
            actionsHtml;
          if (t.type === 'backup') {
            const trigger = li.querySelector('.menu-trigger');
            const menu = li.querySelector('.menu-dropdown');
            const showDetailsBtn = li.querySelector('.show-details');
            const restoreBtn = li.querySelector('.restore');
            trigger.addEventListener('click', e => {
              e.stopPropagation();
              document.querySelectorAll('.assets-actions .menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
              menu.classList.toggle('visible');
            });
            menu.addEventListener('click', e => e.stopPropagation());
            if (showDetailsBtn) showDetailsBtn.addEventListener('click', () => { menu.classList.remove('visible'); openDetailsModal(t); });
            restoreBtn.addEventListener('click', () => {
              menu.classList.remove('visible');
              api('/assets/restore-backup', { env_schema: t.env_schema, table_name: t.table_name }).then(r => {
                if (r.ok) {
                  loadAssets();
                  showToast('Table restored. It will appear in Tables.', 'success');
                } else {
                  showToast(r.json.detail || 'Failed to restore', 'error');
                }
              });
            });
          }
          if (t.type === 'to_be_deleted') {
            const trigger = li.querySelector('.menu-trigger');
            const menu = li.querySelector('.menu-dropdown');
            const showDetailsBtn = li.querySelector('.show-details');
            trigger.addEventListener('click', e => {
              e.stopPropagation();
              document.querySelectorAll('.assets-actions .menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
              menu.classList.toggle('visible');
            });
            menu.addEventListener('click', e => e.stopPropagation());
            if (showDetailsBtn) showDetailsBtn.addEventListener('click', () => { menu.classList.remove('visible'); openDetailsModal(t); });
          }
          if (t.type === 'table') {
            const trigger = li.querySelector('.menu-trigger');
            const menu = li.querySelector('.menu-dropdown');
            const deleteBtn = li.querySelector('.delete');
            trigger.addEventListener('click', e => {
              e.stopPropagation();
              document.querySelectorAll('.assets-actions .menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
              menu.classList.toggle('visible');
            });
            menu.addEventListener('click', e => e.stopPropagation());
            const showDetailsBtn = li.querySelector('.show-details');
            if (showDetailsBtn) showDetailsBtn.addEventListener('click', () => { menu.classList.remove('visible'); openDetailsModal(t); });
            const generateSelectBtn = li.querySelector('.generate-select');
            generateSelectBtn.addEventListener('click', () => {
              menu.classList.remove('visible');
              const url = '/assets/table-columns?env_schema=' + encodeURIComponent(t.env_schema) + '&table_name=' + encodeURIComponent(t.table_name);
              getApi(url).then(r => {
                if (!r.ok) {
                  showToast(r.json.detail || 'Failed to get columns', 'error');
                  return;
                }
                const cols = r.json.columns || [];
                const quoted = cols.map(c => '  "' + String(c).replace(/"/g, '""') + '"');
                const sql = 'SELECT\n' + quoted.join(',\n') + '\nFROM "' + t.env_schema + '"."' + t.table_name.replace(/"/g, '""') + '"';
                navigator.clipboard.writeText(sql).then(() => {
                  showToast('SELECT statement copied to clipboard', 'success');
                }).catch(() => {
                  showToast('Could not copy to clipboard', 'error');
                });
              });
            });
            const generateDdlBtn = li.querySelector('.generate-ddl');
            if (generateDdlBtn) generateDdlBtn.addEventListener('click', () => {
              menu.classList.remove('visible');
              const url = '/assets/table-ddl?env_schema=' + encodeURIComponent(t.env_schema) + '&table_name=' + encodeURIComponent(t.table_name);
              getApi(url).then(r => {
                if (!r.ok) {
                  showToast(r.json.detail || 'Failed to get DDL', 'error');
                  return;
                }
                const ddl = r.json.ddl || '';
                navigator.clipboard.writeText(ddl).then(() => {
                  showToast('DDL copied to clipboard. Paste it in Create table to use.', 'success');
                }).catch(() => {
                  showToast('Could not copy to clipboard', 'error');
                });
              });
            });
            deleteBtn.addEventListener('click', () => {
              menu.classList.remove('visible');
              openDeleteModal(t);
            });
          }
          ul.appendChild(li);
        });
      }).catch(() => {
        loadingEl.style.display = 'none';
        emptyEl.textContent = 'Failed to load tables.';
        emptyEl.style.display = 'block';
      });
    }
    function openDetailsModal(t) {
      document.getElementById('details-modal-title').textContent = t.env_schema + '.' + t.table_name;
      document.getElementById('details-modal-body').innerHTML = '<p class="query-results-loading">Loading…</p>';
      document.getElementById('details-modal').classList.add('visible');
      document.getElementById('details-modal').setAttribute('aria-hidden', 'false');
      const url = '/assets/table-details?env_schema=' + encodeURIComponent(t.env_schema) + '&table_name=' + encodeURIComponent(t.table_name);
      getApi(url).then(r => {
        const body = document.getElementById('details-modal-body');
        if (!r.ok) {
          body.innerHTML = '<p class="query-results-error">' + escapeHtml(r.json.detail || 'Failed to load details') + '</p>';
          return;
        }
        const d = r.json;
        body.innerHTML =
          '<div class="details-stats">' +
          '<div class="details-row"><span class="details-label">Environment</span><span id="details-env">' + escapeHtml(d.env_schema || '') + '</span></div>' +
          '<div class="details-row"><span class="details-label">Owner</span><span id="details-owner">' + escapeHtml(d.owner || '—') + '</span></div>' +
          '<div class="details-row"><span class="details-label">Rows</span><span id="details-rows">' + (d.row_count != null ? Number(d.row_count).toLocaleString() : '—') + '</span></div>' +
          '<div class="details-row"><span class="details-label">Size</span><span id="details-size">' + escapeHtml(d.size_human || '—') + '</span></div>' +
          '</div>' +
          '<h4 class="details-sample-title">Sample data (up to 10 rows)</h4>' +
          '<div id="details-sample-wrap" class="details-sample-wrap"><table id="details-sample-table" class="query-results-table"></table><p id="details-sample-empty" class="query-results-meta" style="display:none;">No rows.</p></div>';
        const cols = d.sample_columns || [];
        const rows = d.sample_rows || [];
        const tableEl = document.getElementById('details-sample-table');
        const emptyEl = document.getElementById('details-sample-empty');
        if (cols.length === 0 || rows.length === 0) {
          tableEl.style.display = 'none';
          emptyEl.style.display = 'block';
        } else {
          tableEl.innerHTML = '';
          const thead = document.createElement('thead');
          thead.innerHTML = '<tr>' + cols.map(c => '<th>' + escapeHtml(String(c)) + '</th>').join('') + '</tr>';
          tableEl.appendChild(thead);
          const tbody = document.createElement('tbody');
          rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = row.map(v => '<td>' + escapeHtml(v === null || v === undefined ? 'NULL' : String(v)) + '</td>').join('');
            tbody.appendChild(tr);
          });
          tableEl.appendChild(tbody);
          tableEl.style.display = 'table';
          emptyEl.style.display = 'none';
        }
      }).catch(() => {
        document.getElementById('details-modal-body').innerHTML = '<p class="query-results-error">Failed to load details.</p>';
      });
    }
    function closeDetailsModal() {
      document.getElementById('details-modal').classList.remove('visible');
      document.getElementById('details-modal').setAttribute('aria-hidden', 'true');
    }
    document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal);
    document.getElementById('details-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeDetailsModal(); });
    let pendingDelete = null;
    function openDeleteModal(t) {
      const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
      const backupName = 'back_up_' + t.table_name + '_' + today;
      const renamed = 'to_be_deleted_' + t.table_name;
      document.getElementById('assets-delete-modal-table').textContent = t.env_schema + '.' + t.table_name;
      document.getElementById('assets-delete-backup-name').textContent = backupName;
      document.getElementById('assets-delete-renamed-name').textContent = renamed;
      pendingDelete = t;
      document.getElementById('assets-delete-modal').classList.add('visible');
      document.getElementById('assets-delete-modal').setAttribute('aria-hidden', 'false');
    }
    function showToast(message, type) {
      type = type === 'error' ? 'error' : 'success';
      const container = document.getElementById('toast-container');
      if (!container) return;
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.setAttribute('role', 'status');
      el.innerHTML = '<span class="toast-message">' + escapeHtml(message) + '</span><button type="button" class="toast-close" aria-label="Close">&times;</button>';
      container.appendChild(el);
      let timeoutId = setTimeout(() => {
        el.classList.add('fade');
        setTimeout(() => el.remove(), 450);
      }, 5000);
      el.querySelector('.toast-close').addEventListener('click', () => {
        clearTimeout(timeoutId);
        el.classList.add('fade');
        setTimeout(() => el.remove(), 450);
      });
    }
    function closeDeleteModal() {
      pendingDelete = null;
      document.getElementById('assets-delete-modal').classList.remove('visible');
      document.getElementById('assets-delete-modal').setAttribute('aria-hidden', 'true');
    }
    document.getElementById('assets-delete-cancel').addEventListener('click', closeDeleteModal);
    document.getElementById('assets-delete-modal').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeDeleteModal();
    });
    document.getElementById('assets-delete-confirm').addEventListener('click', () => {
      if (!pendingDelete) return;
      const t = pendingDelete;
      closeDeleteModal();
      api('/assets/schedule-delete', { env_schema: t.env_schema, table_name: t.table_name }).then(r => {
        if (r.ok) {
          loadAssets();
          showToast('Table scheduled for deletion. Backup created.', 'success');
        } else {
          showToast(r.json.detail || 'Failed to schedule delete', 'error');
        }
      });
    });
    document.querySelectorAll('.filter-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-selected', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-selected', 'true');
        loadAssets();
      });
    });
    (function initEnvDropdown() {
      const wrap = document.getElementById('assets-env-wrap');
      const trigger = document.getElementById('assets-env-trigger');
      const panel = document.getElementById('assets-env-panel');
      const select = document.getElementById('assets-env');
      const label = wrap && wrap.querySelector('.assets-env-label');
      const options = panel && panel.querySelectorAll('.assets-env-option');
      const labels = { '': 'All environments', 'dev': 'dev', 'prod': 'prod' };
      function updateLabel() {
        if (label) label.textContent = labels[select.value] || select.value || 'All environments';
        options && options.forEach(o => {
          o.classList.toggle('active', o.getAttribute('data-value') === select.value);
        });
      }
      function close() {
        wrap && wrap.classList.remove('open');
        trigger && trigger.setAttribute('aria-expanded', 'false');
      }
      if (trigger && wrap && panel) {
        trigger.addEventListener('click', e => {
          e.stopPropagation();
          const isOpen = wrap.classList.toggle('open');
          trigger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
        options && options.forEach(opt => {
          opt.addEventListener('click', () => {
            const v = opt.getAttribute('data-value');
            select.value = v;
            updateLabel();
            close();
            select.dispatchEvent(new Event('change', { bubbles: true }));
          });
        });
        document.addEventListener('click', close);
      }
      updateLabel();
    })();
    document.getElementById('assets-env').addEventListener('change', loadAssets);
    (function initTheme() {
      const KEY = 'datatools-theme';
      const toggle = document.getElementById('theme-toggle');
      function apply(dark) {
        document.documentElement.classList.toggle('dark-mode', dark);
        try { localStorage.setItem(KEY, dark ? 'dark' : 'light'); } catch (_) {}
      }
      function isDark() { return document.documentElement.classList.contains('dark-mode'); }
      try {
        const saved = localStorage.getItem(KEY);
        if (saved === 'dark') apply(true);
        else if (saved === 'light') apply(false);
      } catch (_) {}
      if (toggle) toggle.addEventListener('click', () => apply(!isDark()));
    })();
    let assetsSearchTimer = null;
    document.getElementById('assets-search').addEventListener('input', () => {
      if (assetsSearchTimer) clearTimeout(assetsSearchTimer);
      assetsSearchTimer = setTimeout(loadAssets, 300);
    });
    document.addEventListener('click', () => {
      document.querySelectorAll('.assets-actions .menu-dropdown.visible').forEach(m => m.classList.remove('visible'));
    });
    document.getElementById('btn-assets-create-table').addEventListener('click', () => {
      window.location.hash = 'ddl';
      route();
    });

    function openQueryModal() {
      document.getElementById('query-modal').classList.add('visible');
      document.getElementById('query-modal').setAttribute('aria-hidden', 'false');
      document.getElementById('query-results-loading').style.display = 'none';
      document.getElementById('query-results-error').style.display = 'none';
      document.getElementById('query-results-table-wrap').style.display = 'none';
      document.getElementById('query-sql').focus();
    }
    function closeQueryModal() {
      document.getElementById('query-modal').classList.remove('visible');
      document.getElementById('query-modal').setAttribute('aria-hidden', 'true');
    }
    document.getElementById('query-modal-close').addEventListener('click', closeQueryModal);
    document.getElementById('query-modal-cancel').addEventListener('click', closeQueryModal);
    document.getElementById('query-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeQueryModal(); });
    document.getElementById('query-run-btn').addEventListener('click', () => {
      const sql = document.getElementById('query-sql').value.trim();
      if (!sql) {
        if (typeof showToast === 'function') showToast('Enter a SELECT query.', 'error');
        return;
      }
      const loadingEl = document.getElementById('query-results-loading');
      const errorEl = document.getElementById('query-results-error');
      const tableWrap = document.getElementById('query-results-table-wrap');
      const tableEl = document.getElementById('query-results-table');
      const metaEl = document.getElementById('query-results-meta');
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      tableWrap.style.display = 'none';
      api('/query/run', { sql: sql }).then(r => {
        loadingEl.style.display = 'none';
        if (!r.ok) {
          errorEl.textContent = r.json.detail || 'Query failed';
          errorEl.style.display = 'block';
          if (typeof showToast === 'function') showToast(r.json.detail || 'Query failed', 'error');
          return;
        }
        const cols = r.json.columns || [];
        const rows = r.json.rows || [];
        tableEl.innerHTML = '';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr>' + cols.map(c => '<th>' + escapeHtml(String(c)) + '</th>').join('') + '</tr>';
        tableEl.appendChild(thead);
        const tbody = document.createElement('tbody');
        rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = row.map(v => '<td>' + escapeHtml(v === null || v === undefined ? 'NULL' : String(v)) + '</td>').join('');
          tbody.appendChild(tr);
        });
        tableEl.appendChild(tbody);
        metaEl.textContent = rows.length + ' row' + (rows.length === 1 ? '' : 's');
        tableWrap.style.display = 'block';
        if (typeof showToast === 'function') showToast('Query returned ' + rows.length + ' row(s).', 'success');
      }).catch(e => {
        loadingEl.style.display = 'none';
        errorEl.textContent = e && e.message ? e.message : 'Request failed';
        errorEl.style.display = 'block';
        if (typeof showToast === 'function') showToast('Request failed', 'error');
      });
    });
    window.addEventListener('hashchange', route);
    window.addEventListener('load', route);

    document.querySelectorAll('[data-route]').forEach(el => {
      if (el.tagName === 'A' && el.getAttribute('href')?.startsWith('#')) return;
      el.addEventListener('click', e => {
        const r = el.getAttribute('data-route');
        if (r) { window.location.hash = r; route(); }
      });
    });

    // Create table flow: parsed state (table name, columns, constraints)
    let parsedDdlState = null;
    const TABLE_NAME_GOVERNANCE = /^(ods|dws|dim|ads|dwd)_josephco_(trade|growth)_[a-zA-Z0-9_]+_(di|df|hi|hf)$/i;
    const ALLOWED_TYPES = ['STRING', 'BIGINT', 'DECIMAL', 'TINYINT', 'DATETIME'];
    const TYPE_TO_SQL = {
      'STRING': 'TEXT',
      'BIGINT': 'BIGINT',
      'DECIMAL': 'DECIMAL(10,2)',
      'TINYINT': 'SMALLINT',
      'DATETIME': 'TIMESTAMP'
    };

    function getTypeOption(parsedType) {
      if (!parsedType) return 'STRING';
      const u = (parsedType + '').toUpperCase();
      if (ALLOWED_TYPES.indexOf(parsedType) !== -1) return parsedType;
      if (u === 'BIGINT') return 'BIGINT';
      if (u === 'DECIMAL' || u.indexOf('DECIMAL') !== -1 || u.indexOf('NUMERIC') !== -1) return 'DECIMAL';
      if (u === 'TINYINT' || u === 'SMALLINT' || u === 'INT2') return 'TINYINT';
      if (u.indexOf('TIMESTAMP') !== -1 || u === 'DATE' || u === 'DATETIME') return 'DATETIME';
      return 'STRING';
    }

    function renderColumnsBlock(parsed) {
      const tbody = document.getElementById('columns-tbody');
      tbody.innerHTML = '';
      const tableName = parsed.table || 'table';
      document.getElementById('parsed-table-name').textContent = tableName;
      const columns = parsed.columns || [];
      columns.forEach((col, i) => {
        const typeVal = getTypeOption(col.type);
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML =
          '<td class="col-name">' + escapeHtml(col.name) + '</td>' +
          '<td class="type-cell"><select class="col-type" data-index="' + i + '">' +
          ALLOWED_TYPES.map(t => '<option value="' + escapeHtml(t) + '"' + (t === typeVal ? ' selected' : '') + '>' + t + '</option>').join('') +
          '</select></td>' +
          '<td class="comment-cell"><input type="text" class="col-comment-en" data-index="' + i + '" placeholder="Required" /></td>' +
          '<td class="comment-cell"><input type="text" class="col-comment-zh" data-index="' + i + '" placeholder="必填" /></td>';
        tbody.appendChild(tr);
      });
      document.getElementById('columns-block').classList.add('visible');
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function buildDdlFromColumns() {
      if (!parsedDdlState) return null;
      const tableName = parsedDdlState.table;
      const env = document.getElementById('create-env').value;
      const parts = ['CREATE TABLE "' + env + '"."' + tableName + '" ('];
      const tbody = document.getElementById('columns-tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const colDefs = rows.map(tr => {
        const col = parsedDdlState.columns[parseInt(tr.dataset.index, 10)] || {};
        const name = col.name;
        const typeSel = tr.querySelector('.col-type');
        const typRaw = typeSel ? typeSel.value : 'string';
        const typ = TYPE_TO_SQL[typRaw] != null ? TYPE_TO_SQL[typRaw] : typRaw;
        const nullable = col.nullable !== false;
        const def = col.default || null;
        let seg = '"' + name + '" ' + typ;
        if (!nullable) seg += ' NOT NULL';
        if (def) seg += (String(def).toUpperCase().trim().startsWith('DEFAULT') ? ' ' + def : ' DEFAULT ' + def);
        return seg;
      });
      (parsedDdlState.constraints || []).forEach(c => {
        if (c.raw) colDefs.push(c.raw);
      });
      parts.push(colDefs.join(', '));
      parts.push(')');
      return parts.join('\n');
    }

    function collectColumnComments() {
      if (!parsedDdlState) return [];
      const tbody = document.getElementById('columns-tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      return rows.map(tr => {
        const col = parsedDdlState.columns[parseInt(tr.dataset.index, 10)] || {};
        const name = col.name || '';
        const enInput = tr.querySelector('.col-comment-en');
        const zhInput = tr.querySelector('.col-comment-zh');
        return {
          column_name: name,
          comment_en: (enInput && enInput.value) ? enInput.value.trim() : '',
          comment_zh: (zhInput && zhInput.value) ? zhInput.value.trim() : ''
        };
      });
    }

    document.getElementById('btn-parse-ddl').addEventListener('click', async () => {
      const ddl = document.getElementById('create-ddl').value.trim();
      const resultEl = document.getElementById('result-create');
      resultEl.textContent = '';
      resultEl.style.display = 'none';
      if (!ddl) {
        showResult(resultEl, 'Paste a CREATE TABLE statement first.', true);
        return;
      }
      const res = await api('/ddl/parse', { ddl });
      if (!res.ok) {
        showResult(resultEl, res.json?.detail || res.json || 'Parse failed', true);
        document.getElementById('columns-block').classList.remove('visible');
        return;
      }
      parsedDdlState = res.json;
      const tableName = (res.json.table || '').trim();
      if (!TABLE_NAME_GOVERNANCE.test(tableName)) {
        renderColumnsBlock(res.json);
        showResult(resultEl, 'Table name must follow: {ods|dws|dim|ads|dwd}_josephco_{trade|growth}_{tablename}_{di|df|hi|hf}. Example: ods_josephco_growth_users_di. Got: "' + tableName + '". Edit your DDL and re-parse, then Create table.', true);
        return;
      }
      renderColumnsBlock(res.json);
      showResult(resultEl, 'Parsed. Edit column types if needed, then click Create table.', false);
    });

    document.getElementById('btn-create-table').addEventListener('click', async () => {
      const resultEl = document.getElementById('result-create');
      const btn = document.getElementById('btn-create-table');
      if (!parsedDdlState) {
        showResult(resultEl, 'Parse the DDL first (Parse & edit columns).', true);
        return;
      }
      const columnComments = collectColumnComments();
      const missing = columnComments.filter(cc => !cc.comment_en || !cc.comment_zh);
      if (missing.length) {
        const names = missing.map(cc => cc.column_name).join(', ');
        showResult(resultEl, 'Data governance: every column must have both Comment (EN) and Comment (ZH). Missing for: ' + names + '. Use "Generate comments with AI" or fill manually.', true);
        return;
      }
      let ddl;
      try {
        ddl = buildDdlFromColumns();
      } catch (e) {
        showResult(resultEl, 'Error building DDL: ' + (e && e.message ? e.message : String(e)), true);
        return;
      }
      if (!ddl) {
        showResult(resultEl, 'Could not build DDL from columns.', true);
        return;
      }
      btn.disabled = true;
      resultEl.textContent = 'Creating table…';
      resultEl.className = 'result-box';
      resultEl.style.display = 'block';
      try {
        const res = await api('/ddl/apply', {
          ddl,
          env_schema: document.getElementById('create-env').value,
          column_comments: columnComments
        });
        const msg = res.ok ? res.json : (res.json?.detail ?? res.json);
        const isObj = typeof msg === 'object';
        showResult(resultEl, isObj ? JSON.stringify(msg, null, 2) : msg, !res.ok);
      } catch (e) {
        showResult(resultEl, 'Request failed: ' + (e && e.message ? e.message : String(e)) + '. Check the server is running and you are on the same port (e.g. http://localhost:8001).', true);
      } finally {
        btn.disabled = false;
      }
    });

    document.getElementById('btn-suggest-comments').addEventListener('click', async () => {
      const resultEl = document.getElementById('result-create');
      if (!parsedDdlState) {
        showResult(resultEl, 'Parse the DDL first (Parse & edit columns).', true);
        return;
      }
      const tbody = document.getElementById('columns-tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const columns = rows.map(tr => {
        const col = parsedDdlState.columns[parseInt(tr.dataset.index, 10)] || {};
        const typeSel = tr.querySelector('.col-type');
        return { name: col.name || '', type: (typeSel && typeSel.value) || 'TEXT' };
      });
      const btn = document.getElementById('btn-suggest-comments');
      btn.disabled = true;
      resultEl.textContent = 'Generating comments with AI…';
      resultEl.className = 'result-box';
      resultEl.style.display = 'block';
      try {
        const res = await api('/ddl/suggest-column-comments', {
          columns,
          table_name: parsedDdlState.table || undefined
        });
        if (!res.ok) {
          showResult(resultEl, res.json?.detail || res.json || 'AI suggestion failed', true);
          return;
        }
        const suggestions = (res.json && res.json.suggestions) || [];
        suggestions.forEach(s => {
          const idx = parsedDdlState.columns.findIndex(c => c.name === s.column_name);
          if (idx === -1) return;
          const tr = tbody.querySelector('tr[data-index="' + idx + '"]');
          if (!tr) return;
          const enInput = tr.querySelector('.col-comment-en');
          const zhInput = tr.querySelector('.col-comment-zh');
          if (enInput) enInput.value = s.comment_en || '';
          if (zhInput) zhInput.value = s.comment_zh || '';
        });
        showResult(resultEl, 'Comments filled. Review and edit if needed, then click Create table.', false);
      } catch (e) {
        showResult(resultEl, 'Request failed: ' + (e && e.message ? e.message : String(e)), true);
      } finally {
        btn.disabled = false;
      }
    });
    document.getElementById('btn-suggest').addEventListener('click', async () => {
      const el = document.getElementById('result-suggest');
      const res = await api('/compare/suggest-keys', {
        left_table: document.getElementById('suggest-left').value.trim(),
        right_table: document.getElementById('suggest-right').value.trim(),
        env_schema: document.getElementById('suggest-schema').value,
        max_candidates: parseInt(document.getElementById('suggest-max').value, 10) || 5
      });
      showResult(el, res.ok ? res.json : (res.json?.detail ?? res.json), !res.ok);
    });
    document.getElementById('btn-compare').addEventListener('click', async () => {
      const el = document.getElementById('result-compare');
      const keys = document.getElementById('compare-keys').value.trim().split(',').map(s => s.trim()).filter(Boolean);
      const res = await api('/compare/run', {
        left_table: document.getElementById('compare-left').value.trim(),
        right_table: document.getElementById('compare-right').value.trim(),
        env_schema: document.getElementById('compare-schema').value,
        join_keys: keys.length ? keys : ['id'],
        compare_columns: null,
        sample_limit: parseInt(document.getElementById('compare-limit').value, 10) || 50
      });
      showResult(el, res.ok ? res.json : (res.json?.detail ?? res.json), !res.ok);
    });
    document.getElementById('btn-validate').addEventListener('click', async () => {
      const el = document.getElementById('result-validate');
      const keysStr = document.getElementById('validate-keys').value.trim();
      const res = await api('/validate/run', {
        target_table: document.getElementById('validate-table').value.trim(),
        env_schema: document.getElementById('validate-schema').value,
        key_columns: keysStr ? keysStr.split(',').map(s => s.trim()).filter(Boolean) : null
      });
      showResult(el, res.ok ? res.json : (res.json?.detail ?? res.json), !res.ok);
    });
  </script>
</body>
</html>
